<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
</head>
<style>
    body {
        background-color: black;
        color: white;
        margin: 0;
        padding: 0;
    }

    body a {
        color: white;
    }

    #maincontain {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-items: center;
        height: 98vh;
        overflow: hidden;
    }

    #panel2panel1 {
        display: flex;
        gap: 2%;
        height: 90vh;
        width: 96%;
        margin: 0 2% 0 2%;
        min-width: 0;
        flex-basis: 90%;
    }

    .flexdirection {
        flex-direction: row;
    }

    #panel2 {
        width: 59%;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-items: center;
        margin-left: 1.8%;
        min-width: 0;
        flex-basis: 59%;
    }

    #panel1 {
        width: 39%;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
        justify-items: center;
        align-content: center;
        overflow: hidden;
    }

    #albumcover {
        display: block;
        width: 100%;
    }

    #controls {
        display: none;
        flex-wrap: wrap;
        flex-direction: row;
        align-items: center;
        justify-items: flex-start;
        /*gap: 1vh;*/
        width: 100%;
        height: 100%;
        font-size: 3vh;
        overflow-y: scroll;
        overflow-x: hidden;
        -ms-overflow-style: none;
        /* Hide scrollbar for IE and Edge */
        scrollbar-width: none;
        /* Hide scrollbar for Firefox */
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    #controls::-webkit-scrollbar,
    #playlist::-webkit-scrollbar,
    #playqueue::-webkit-scrollbar,
    #browse::-webkit-scrollbar {
        display: none;
    }

    #actions,
    #presets {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        gap: 1vh;
    }

    #controls button,
    #playlist button,
    #playqueue button {
        font-size: 3vh;
        height: auto;
        width: auto;
        text-align: center;
        margin: 0 1vh 1vh 0;
    }

    #presets button {
        width: auto;
    }

    #hideControls {
        height: 4vh;
    }

    #receiverON {
        display: none;
    }

    #receiverOFF {
        display: none;
    }

    #receiverInputBluOS {
        display: none;
    }

    #progressslider {
        /* Override default CSS styles */
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 0px;
        background: black;
        /* Remove outline */
        outline: none;
        position: fixed;
        left: 0px;
        bottom: 0px;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 50px;
        height: 0.5vh;
        background: white;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 50px;
        height: 10px;
        background: white;
        cursor: pointer;
    }

    #playqueue {
        display: none;
        flex-direction: column;
        flex-wrap: nowrap;
        gap: 1vh;
        width: 100%;
        height: 100%;
        font-size: 2vh;
        overflow: scroll;
        overflow-y: scroll;
        overflow-x: hidden;
        /* Hide scrollbar for IE and Edge */
        -ms-overflow-style: none;
        /* Hide scrollbar for Firefox */
        scrollbar-width: none;
    }

    .queuescrollspace {
        width: 100%;
        margin-bottom: 100vh;
    }

    #browse {
        display: none;
        flex-direction: column;
        flex-wrap: wrap;
        gap: 1vh;
        width: 100%;
        height: 100%;
        font-size: 2vh;
        overflow: scroll;
        overflow-y: scroll;
        overflow-x: hidden;
        /* Hide scrollbar for IE and Edge */
        -ms-overflow-style: none;
        /* Hide scrollbar for Firefox */
        scrollbar-width: none;
    }

    #browse iframe {
        height: 100%;
        border: none;
    }

    #playlist {
        display: none;
        flex-direction: column;
        flex-wrap: nowrap;
        /*align-items: flex-start;*/
        gap: 1vh;
        width: 100%;
        height: 100%;
        font-size: 2vh;
        overflow: scroll;
        overflow-y: scroll;
        overflow-x: hidden;
        /* Hide scrollbar for IE and Edge */
        -ms-overflow-style: none;
        /* Hide scrollbar for Firefox */
        scrollbar-width: none;
    }

    .playlistsong {
        height: 10vh;
        width: 100%;
        display: flex;
        flex-wrap: nowrap;
        font-size: 3vh;
        gap: 1vh;
        margin-bottom: 1vh;
    }

    .playlistalbumcover {
        height: 9vh;
        width: 10vh;
        margin-right: 1vh;
        overflow: hidden;
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        justify-items: center;
    }

    .playlistalbumcover span {
        margin: 0 auto 0 auto;
    }

    .playlistalbumcover img {
        height: 9h;
        width: 9vh;
        overflow: hidden;
        display: block;
    }

    .playlistsongmeta {
        height: 10vh;
        width: 90%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }

    .playlistsongtitle {
        font-size: 3vh;
        height: 4vh;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .playlistsongartist {
        font-size: 2vh;
        height: 2.5vh;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .playlistsongalbum {
        font-size: 2vh;
        height: 2.5vh;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .playlistsongservice {
        font-size: 1.5vh;
        height: 2vh;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    #playlistsongserviceicon {
        height: 1.5vh;
        width: 1.5vh;
        margin-right: 0.5vh;
    }

    #songTitle {
        font-size: 12vh;
        width: 59vw;
        line-height: 13.5vh;
        max-height: 27vh;
        overflow: hidden;
        text-overflow: ellipsis;
        -webkit-line-clamp: 2;
        /* number of lines to show */
        -webkit-box-orient: vertical;
    }

    #artistName {
        font-size: 8vh;
        width: 59vw;
        height: 9vh;
        margin-top: 3vh;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #albumTitle {
        font-size: 5vh;
        margin-top: 3vh;
        width: 59vw;
        height: 6vh;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #meta {
        display: flex;
        margin-top: 3vh;
        font-size: 3vh;
        width: 59vw;
        height: 4vh;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    #serviceIcon {
        width: 3vh;
        height: 3vh;
        overflow: hidden;
    }

    #station {
        margin-left: 1vh;
        white-space: nowrap;
    }

    #quality {
        margin-left: 1vh;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /*@media screen and (max-width: 500px)*/
    @media (orientation: portrait) {
        .flex-direction {
            flex-direction: column;
        }

        #panel1 {
            width: 94vw;
            height: 50vh;
        }

        #panel2 {
            width: 94vw;
            height: 50vh;
        }

        #albumcover {
            height: 100%;
            width: auto;
            margin: 0 auto 0 auto;
        }

        #songTitle {
            font-size: 10vw;
            line-height: 11vw;
            max-height: 22vw;
            width: 94vw;
        }

        #artistName {
            font-size: 8vw;
            height: 9vw;
            width: 94vw;
        }

        #albumTitle {
            font-size: 6vw;
            height: 7vw;
            width: 94vw;
        }

        #meta {
            font-size: 4vw;
            height: 5vw;
            width: 94vw;
        }

        #serviceIcon {
            width: 4vw;
            height: 4vw;
            overflow: hidden;
        }
    }
</style>

<body>
    <div id="maincontain">
        <div id="panel2panel1" class="flex-direction">
            <div id="panel1">
                <img onclick="toggleControls();" id="albumcover" src="" />
                <div id="controls" style="display:none;">
                    <button onclick="control('/Pause?toggle=1')" id="togglePause">Play </button>
                    <button onclick="control('/Back')" id="back">Back</button>
                    <button onclick="control('/Skip')" id="skip">Skip</button>
                    <button onclick="control(VolumeUpUrl)" id="volumeUp">Vol +</button>
                    <button onclick="control(VolumeDownUrl)" id="volumeDown">Vol -</button>
                    <div id="actions">
                    </div>
                    <button onclick="loadPanel1View('playlist')" id="togglesonghistory">History</button>
                    <button onclick="showBrowseContent()" id="showbrowsecontent">Browse</button>
                    <button onclick="control(receiverOnUrl)" id="receiverON">ON</button>
                    <button onclick="control(receiverOffUrl)" id="receiverOFF">OFF</button>
                    <button onclick="control(receiverInputBluOSUrl)" id="receiverInputBluOS">BluOS</button>
                    <button onclick="showPlayQueue()">Queue</button>
                    <button onclick="browseUrl('http://' + ipAddress)">Settings</button>
                    <button onclick="location.reload()">Reload</button>
                    <div id="presets">
                    </div>
                    <img onclick="toggleControls();" id="hideControls" src="">
                </div>
                <div id="playlist" style="display:none;"></div>
                <div id="playqueue" style="display:none;"></div>
                <div id="browse" style="display:none;"></div>
            </div>
            <div onclick="toggleControls()" id="panel2">
                <div id="panel2flex">
                    <div id="songTitle"></div>
                    <div id="artistName"></div>
                    <div id="albumTitle"></div>
                    <div id="meta">
                        <img id="serviceIcon" src="" />
                        <div id="station">
                        </div>
                        <div id="quality">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="range" min="1" max="100" value="0" class="slider" id="progressslider">
    <script>
        //Change ipAddress and port to that of your BluOS player:    
        var ipAddress = "192.168.2.86";
        var port = "11000";
        var receiverOnUrl = 'http://192.168.2.79:8000/api/PWON';
        var receiverOffUrl = 'http://192.168.2.79:8000/api/PWSTANDBY';
        var receiverInputBluOSUrl = 'http://192.168.2.79:8000/api/MSQUICK1';
        var receiverVolumeUpUrl = 'http://192.168.2.79:8000/api/MVUP';
        var receiverVolumeDownUrl = 'http://192.168.2.79:8000/api/MVDOWN';
        //stop editing here unless you know what your are doing :)
        var url = 'http://' + ipAddress + ':' + port;
        var previousBrowse = '';
        var searchQuery = '';
        var update = 1;
        var call = 1;
        var eTag = "";
        var playState = '';
        let playHistory = [];
        let browseBreadCrumbs = ["loadPanel1View('controls')"];
        const albumCover = document.getElementById('albumcover');
        const controls = document.getElementById('controls');
        const playList = document.getElementById('playlist');
        const playQueue = document.getElementById('playqueue');
        const browse = document.getElementById('browse');
        const progressSlider = document.getElementById('progressslider');
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ipaddress') != null) {
            ipAddress = urlParams.get('ipaddress');
        }
        if (receiverVolumeUpUrl != '' && receiverVolumeUpUrl != '') {
            var VolumeUpUrl = receiverVolumeUpUrl;
            var VolumeDownUrl = receiverVolumeDownUrl;
        } else {
            var VolumeUpUrl = '/Volume?db=1&tell_slaves=off';
            var VolumeDownUrl = '/Volume?db=-1&tell_slaves=off';
        }
        var progressUpdater = window.setInterval(updateProgressSlider, 1000); //window.clearInterval(progressUpdater);
        if (progressSlider.addEventListener) {
            progressSlider.addEventListener("click", setSeek, false);
        } else if (progressSlider.attachEvent) {
            progressSlider.attachEvent('onclick', setSeek);
        }
        longPoll();
        // TODO in longPoll:
        // show current and total track time
        // make artist and album clickable?
        function longPoll() {
            var xhttp = new XMLHttpRequest();
            //console.log("Api call " + call);
            xhttp.open("GET", url + "/Status?timeout=100&etag=" + eTag, true);
            xhttp.send();
            const tryAgain = setTimeout(() => {
                //console.log("Initiate timeout api call " + call + " (update " + update + ")");
                xhttp.abort;
                longPoll();
            }, 101000);
            xhttp.onreadystatechange = function () {
                //console.log("Readystate " + xhttp.readyState + " / Status " + xhttp.status);
                if (xhttp.readyState == 4) {
                    if (xhttp.status == 200) {
                        listpresets();
                        //console.log("Cancel timeout api call " + (call - 1) + " (update " + update + ")");
                        clearTimeout(tryAgain);
                        var xmlDoc = xhttp.responseXML;
                        eTag = xmlDoc.getElementsByTagName('status')[0].getAttribute('etag');
                        var quality;
                        let song = {
                            "time": new Date(),
                        };
                        if (typeof xmlDoc.getElementsByTagName("serviceName")[0] != 'undefined') {
                            song.service = xmlDoc.getElementsByTagName("serviceName")[0].innerHTML;
                            if (xmlDoc.getElementsByTagName("serviceName")[0].innerHTML == "Radio Paradise") {
                                if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {

                                    song.title = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                                } else {

                                    song.title = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {

                                    song.artist = xmlDoc.getElementsByTagName("title3")[0].innerHTML.split(" • ")[0];
                                } else {

                                    song.artist = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {

                                    song.album = xmlDoc.getElementsByTagName("title3")[0].innerHTML.split(" • ")[1];
                                } else {

                                    song.album = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {

                                    song.station = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                                } else {

                                    song.station = '';
                                }
                            } else if (xmlDoc.getElementsByTagName("serviceName")[0].innerHTML == "Calm Radio") {
                                if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {

                                    song.title = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                                } else {

                                    song.title = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {

                                    song.station = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                                } else {

                                    song.station = '';
                                }

                                song.album = '';

                                song.artist = '';
                            } else if (xmlDoc.getElementsByTagName("serviceName")[0].innerHTML == "TuneIn") {
                                if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {

                                    song.title = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                                } else {

                                    song.title = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {

                                    song.artist = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                                } else {

                                    song.artist = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {

                                    song.album = xmlDoc.getElementsByTagName("title3")[0].innerHTML;
                                } else {

                                    song.album = '';
                                }

                                song.station = xmlDoc.getElementsByTagName("serviceName")[0].innerHTML;
                            } else {
                                if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {

                                    song.title = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                                } else {

                                    song.title = '';
                                }
                                if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {

                                    song.artist = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                                } else {

                                    song.artist = "";
                                }
                                if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {

                                    song.album = xmlDoc.getElementsByTagName("title3")[0].innerHTML;;
                                } else {

                                    song.album = '';
                                }

                                song.station = '';
                            }
                        } else {
                            if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {

                                song.title = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                            } else {

                                song.title = '';
                            }
                            if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {

                                song.artist = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                            } else {

                                song.artist = "";
                            }
                            if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {

                                song.album = xmlDoc.getElementsByTagName("title3")[0].innerHTML;;
                            } else {

                                song.album = '';
                            }

                            song.station = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("image")[0] != "undefined") {
                            if (xmlDoc.getElementsByTagName("image")[0].innerHTML.startsWith("http")) {

                                song.albumCover = xmlDoc.getElementsByTagName("image")[0].innerHTML;
                            } else {

                                song.albumCover = "http://" + ipAddress + ":" + port + xmlDoc.getElementsByTagName("image")[0].innerHTML;
                            }
                        } else {

                            song.albumCover = '';
                        }
                        document.getElementById("hideControls").src = song.albumCover;
                        if (typeof xmlDoc.getElementsByTagName("serviceIcon")[0] != "undefined") {

                            song.serviceIcon = "http://" + ipAddress + ":" + port + xmlDoc.getElementsByTagName("serviceIcon")[0].innerHTML;
                            document.getElementById("serviceIcon").style = 'display:block;';
                        } else {

                            song.serviceIcon = '';
                            document.getElementById("serviceIcon").style = 'display:none;';
                        }
                        if (typeof xmlDoc.getElementsByTagName("quality")[0] != "undefined") {
                            if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "mqa") {

                                song.quality = "MQA <span style=\"color:#4dbb63;\">•</span>";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "mqaAuthored") {

                                song.quality = "MQA <span style=\"color:#3ec4e4;\">•</span>";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "hd") {

                                song.quality = "Hi&middot;Res";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "cd") {

                                song.quality = "CD";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "dolbyAudio") {

                                song.quality = "DolbyDigital";
                            } else {

                                song.quality = xmlDoc.getElementsByTagName("quality")[0].innerHTML;
                            }
                        } else if (typeof xmlDoc.getElementsByTagName("streamUrl")[0] != "undefined") {

                            song.quality = xmlDoc.getElementsByTagName("streamUrl")[0].innerHTML;
                        } else {

                            song.quality = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("quality")[0] != "undefined") {
                            if (typeof xmlDoc.getElementsByTagName("streamFormat")[0] != "undefined" && xmlDoc.getElementsByTagName("quality")[0].innerHTML != "mqa" && xmlDoc.getElementsByTagName("quality")[0].innerHTML != "mqaAuthored") {
                                if (typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[0] != "undefined" && typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[0] != "undefined" && typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[1] != "undefined" && typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[2] != "undefined") {

                                    song.quality += ' ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[0] + ' ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[1] + '-bit/' + (xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[0] / 1000) + 'kHz ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[2] + 'ch';
                                } else {

                                    song.quality += ' (' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML + ')';
                                }
                            }
                        } else {
                            if (typeof xmlDoc.getElementsByTagName("streamFormat")[0] != "undefined") {
                                if (typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[0] != "undefined" && typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[0] != "undefined" && typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[1] != "undefined" && typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[2] != "undefined") {

                                    song.quality += ' ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[0] + ' ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[1] + '-bit/' + (xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[0] / 1000) + 'kHz ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[2] + 'ch';
                                } else {

                                    song.quality += ' (' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML + ')';
                                }
                            }
                        }
                        if (typeof xmlDoc.getElementsByTagName("fn")[0] != "undefined") {
                            song.fn = xmlDoc.getElementsByTagName("fn")[0].innerHTML;
                        } else {
                            song.fn = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("song")[0] != "undefined") {
                            song.queuePos = xmlDoc.getElementsByTagName("song")[0].innerHTML;
                        } else {
                            song.queuePos = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("totlen")[0] != "undefined") {
                            song.length = xmlDoc.getElementsByTagName("totlen")[0].innerHTML;
                        } else {
                            song.length = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("secs")[0] != "undefined") {
                            song.position = xmlDoc.getElementsByTagName("secs")[0].innerHTML;
                        } else {
                            song.position = '';
                        }
                        document.getElementById("songTitle").innerHTML = song.title;
                        document.getElementById("artistName").innerHTML = song.artist;
                        document.getElementById("albumTitle").innerHTML = song.album;
                        document.getElementById("station").innerHTML = song.station;
                        document.getElementById("albumcover").src = song.albumCover;
                        document.getElementById("hideControls").src = song.albumCover;
                        document.getElementById("serviceIcon").src = song.serviceIcon;
                        document.getElementById("quality").innerHTML = song.quality;
                        if (song.length != '') {
                            progressSlider.max = song.length;
                        }
                        if (song.position != '') {
                            progressSlider.value = song.position;
                        }
                        if (song.title != '' || song.artist != '' || song.album != '') {
                            if (typeof playHistory[0] === 'undefined') {
                                playHistory.unshift(song);
                                addSongtoHistory(song.title, song.artist, song.album, song.albumCover, song.service, song.quality, song.time, song.station, song.serviceIcon, song.fn);
                            } else {
                                if (playHistory[0].title != song.title || playHistory[0].artist != song.artist || playHistory[0].album != song.album || playHistory[0].service != song.service) {
                                    playHistory.unshift(song);
                                    addSongtoHistory(song.title, song.artist, song.album, song.albumCover, song.service, song.quality, song.time, song.station, song.serviceIcon, song.fn);
                                } else {
                                    playHistory[0].quality = song.quality;
                                    document.getElementsByClassName('playlistsong')[0].remove();
                                    addSongtoHistory(song.title, song.artist, song.album, song.albumCover, song.service, song.quality, song.time, song.station, song.serviceIcon, song.fn);

                                }
                            }
                        }
                        focusSongInQueue();
                        //console.log(song);
                        //console.log(xmlDoc);
                        if (typeof xmlDoc.getElementsByTagName("state")[0] != "undefined") {
                            if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'pause') {
                                playState = 'pause';
                                document.getElementById("togglePause").innerHTML = "Play ";
                                document.getElementById("togglePause").style.display = 'inline-block';
                                document.getElementById("back").style.display = 'inline-block';
                                document.getElementById("skip").style.display = 'inline-block';
                            } else if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'play') {
                                playState = 'play';
                                document.getElementById("togglePause").innerHTML = "Pause";
                                document.getElementById("togglePause").style.display = 'inline-block';
                                document.getElementById("back").style.display = 'inline-block';
                                document.getElementById("skip").style.display = 'inline-block';
                            } else if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'stream') {
                                playState = 'stream';
                                progressSlider.max = 1000;
                                document.getElementById("togglePause").innerHTML = "Pause";
                                document.getElementById("togglePause").style.display = 'inline-block';
                                document.getElementById("back").style.display = 'none';
                                document.getElementById("skip").style.display = 'none';
                            } else if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'stop') {
                                playState = 'stop';
                                document.getElementById("togglePause").style.display = 'none';
                                document.getElementById("back").style.display = 'none';
                                document.getElementById("skip").style.display = 'none';
                            } else {
                                playState = '';
                                document.getElementById("togglePause").style.display = 'none';
                                document.getElementById("back").style.display = 'none';
                                document.getElementById("skip").style.display = 'none';
                            }
                        }
                        document.getElementById("actions").innerHTML = '';
                        if (typeof xmlDoc.getElementsByTagName("action")[0] != "undefined") {
                            for (i = 0; i < xmlDoc.getElementsByTagName("action").length; i++) {
                                if (typeof xmlDoc.getElementsByTagName("action")[i].getAttribute('url') != 'undefined' && xmlDoc.getElementsByTagName("action")[i].getAttribute('url') != null) {
                                    document.getElementById("actions").innerHTML += '<button onclick=\"control(\'' + xmlDoc.getElementsByTagName("action")[i].getAttribute('url') + '\')\"" id=\"' + xmlDoc.getElementsByTagName("action")[i].getAttribute('name') + '\">' + xmlDoc.getElementsByTagName("action")[i].getAttribute('name') + '</button>';
                                }
                            }
                        }
                        if (receiverOnUrl != '') {
                            document.getElementById("receiverON").style.display = 'inline-block';
                        }
                        if (receiverOffUrl != '') {
                            document.getElementById("receiverOFF").style.display = 'inline-block';
                        }
                        if (receiverInputBluOSUrl != '') {
                            document.getElementById("receiverInputBluOS").style.display = 'inline-block';
                        }
                        //console.log("Update " + update);
                        update = update + 1;
                    }
                    if (xhttp.status > 0) {
                        longPoll();
                    }
                }
            };
            call = call + 1;
        }
        function updateProgressSlider() {
            if (playState == 'play' || playState == 'stream') {
                var oldValue = Number(progressSlider.value);
                var newValue = oldValue + 1;
                progressSlider.value = newValue;
                if (playState == 'stream') {
                    var maxValue = Number(progressSlider.max);
                    if (newValue > maxValue) {
                        progressSlider.value = 0;
                    }
                }
                //console.log('oldvalue: ' + oldValue);
                //console.log('newvalue: ' + newValue);
                //console.log('playState: ' + playState);
            }

        }
        function setSeek() {
            var position = progressSlider.value;
            if (playState == 'play') {
                control('/Play?seek=' + position);
            }
            if (playState == 'pause') {
                control('/Play?seek=' + position);
                const delayedPause = setTimeout(() => {
                    control('/Pause');
                }, 500);
            }
        }
        function toggleControls() {
            if (albumCover.style.display === 'none') {
                loadPanel1View('albumcover');
            } else {
                loadPanel1View('controls');
            }
        }
        function showPlayQueue() {
            getPlayQueue();
            loadPanel1View('playqueue');
            const focusSong = setTimeout(() => {
                focusSongInQueue();
            }, 1000);
        }
        function focusSongInQueue() {
            if (typeof playHistory[0] != 'undefined' && playQueue.style.display != 'none' && playHistory[0].queuePos != '' && typeof document.getElementById(playHistory[0].queuePos) != 'undefined') {
                try {
                    document.getElementById(playHistory[0].queuePos).scrollIntoView();
                } catch (error) {
                    console.error(error);
                }
            }
        }
        function showBrowseContent() {
            browseContent();
            loadPanel1View('browse');
        }
        function browseUrl(externalUrl) {
            browse.innerHTML = '<iframe src="' + externalUrl + '">';
            loadPanel1View('browse');
        }
        function loadPanel1View(view) {
            controls.style.display = 'none';
            playQueue.style.display = 'none';
            albumCover.style.display = 'none';
            playList.style.display = 'none';
            browse.style.display = 'none';
            switch (view) {
                case 'controls':
                    controls.style.display = 'flex';
                    break;
                case 'playqueue':
                    playQueue.style.display = 'flex';
                    break;
                case 'playlist':
                    playList.style.display = 'flex';
                    break;
                case 'browse':
                    browse.style.display = 'flex';
                    break;
                default:
                    albumCover.style.display = 'block';
                    break;
            }
        }
        function addSongtoHistory(songTitle, songArtist, songAlbum, albumCover, service, quality, time, station, serviceicon, fn) {
            var level1 = songTitle;
            var level2 = songArtist;
            var level3 = songAlbum;
            var level4 = '';
            var imageUrl = albumCover;
            var iconUrl = '';
            var action0 = '';
            var action1 = '';
            var id = fn || ' ';
            var action2 = '';
            var action3 = '';
            if (typeof serviceicon != 'undefined' && serviceicon != '') {
                iconUrl = serviceicon;
                level4 = station + ' ' + quality;
            } else {
                level4 = service + ' ' + station + ' ' + quality;
            }
            if (fn) {
                action0 = "control('/Add?id=" + fn + "&playnow=1')";
            }
            playList.innerHTML = buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3) + playList.innerHTML;
        }
        function addSongToQueue(songTitle, songArtist, songAlbum, albumCover, service, quality, songid, id) {
            var level1 = songTitle;
            var level2 = songArtist;
            var level3 = songAlbum;
            var level4 = '';
            var imageUrl = url + '/Artwork?service=' + service + '&songid=' + songid;
            var iconUrl = '';
            var action0 = '';
            var action1 = '';
            var id = id || '';
            var action2 = '';
            var action3 = '';
            if (typeof serviceicon != 'undefined' && serviceicon != '') {
                iconUrl = serviceicon;
                level4 = quality;
            } else {
                level4 = service + ' ' + quality;
            }
            action1 = "control('/Play?id=" + id + "')";
            action2 = "removeFromQueue(" + id + ")";
            playQueue.innerHTML += buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3);
        }
        function buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3) {
            id = id || ' ';
            if (action0 && !action1 && !action2 && !action3) {
                var songHtml = '<div id="' + id + '" onclick="' + action0 + '" class="playlistsong">';
            } else {
                var songHtml = '<div id="' + id + '" class="playlistsong">';
            }
            if (imageUrl) {
                if (imageUrl.startsWith('http')) {
                    imageUrl = imageUrl;
                } else if (imageUrl.startsWith('/')) {
                    imageUrl = url + imageUrl;
                } else {
                    var action1Text = imageUrl;
                    imageUrl = '';
                }
            }
            if (imageUrl || action1Text) {
                if (action0 && (action1 || action2 || action3)) {
                    songHtml += '<div onclick="' + action0 + '" class="playlistalbumcover">';
                } else {
                    songHtml += '<div class="playlistalbumcover">';
                }
                if (imageUrl) {
                    songHtml += '<img src="' + imageUrl + '">';
                }
                if (action1Text) {
                    songHtml += '<span class="action1text">' + action1Text + '</span>';
                }
                songHtml += '</div>';
            }
            if (action1 && !action2 && !action3) {
                songHtml += '<div onclick="' + action1 + '" class="playlistsongmeta">';
            } else {
                songHtml += '<div class="playlistsongmeta">';
            }
            if (level1) {
                if (action1) {
                    songHtml += '<div onclick="' + action1 + '" class="playlistsongtitle">' + level1 + '</div>';
                } else {
                    songHtml += '<div class="playlistsongtitle">' + level1 + '</div>';
                }
            }
            if (level2) {
                if (action2) {
                    songHtml += '<div onclick="' + action2 + '" class="playlistsongartist">' + level2 + '</div>';
                } else {
                    songHtml += '<div class="playlistsongartist">' + level2 + '</div>';
                }
            }
            if (level3) {
                if (action3) {
                    songHtml += '<div onclick="' + action3 + '" class="playlistsongalbum">' + level3 + '</div>';
                } else {
                    songHtml += '<div class="playlistsongalbum">' + level3 + '</div>';
                }
            }
            if (iconUrl || level4) {
                songHtml += '<div class="playlistsongservice">';
                if (iconUrl) {
                    songHtml += '<img id="playlistsongserviceicon" src="' + iconUrl + '">';
                }
                if (level4) {
                    songHtml += level4;
                }
                songHtml += '</div>';
            }
            songHtml += '</div>';
            songHtml += '</div>';
            return songHtml;
        }
        function control(message) {
            var xhttpa = new XMLHttpRequest();
            if (message.startsWith('http')) {
                xhttpa.open("GET", message, true);
            } else {
                xhttpa.open("GET", url + message, true);
            }
            xhttpa.send();
            xhttpa.onreadystatechange = function () {
                if (xhttpa.readyState == 4) {
                    if (xhttpa.status == 200) {
                        var xmlDoca = xhttpa.responseXML;
                    }
                }
            };
        }
        function getPlayQueue() {
            var xhttpQ = new XMLHttpRequest();
            xhttpQ.open("GET", url + '/Playlist', true);
            xhttpQ.send();
            xhttpQ.onreadystatechange = function () {
                if (xhttpQ.readyState == 4) {
                    if (xhttpQ.status == 200) {
                        var xmlDocQ = xhttpQ.responseXML;
                        playQueue.innerHTML = '';
                        const queueLength = xmlDocQ.getElementsByTagName("song").length;

                        i = 0;
                        if (typeof xmlDocQ.getElementsByTagName("song")[0] != "undefined") {
                            for (i = 0; i < queueLength && i < 100; i++) {
                                addSongToQueue(xmlDocQ.getElementsByTagName("song")[i].getElementsByTagName("title")[0].innerHTML, xmlDocQ.getElementsByTagName("song")[i].getElementsByTagName("art")[0].innerHTML, xmlDocQ.getElementsByTagName("song")[i].getElementsByTagName("alb")[0].innerHTML, '', xmlDocQ.getElementsByTagName("song")[i].getAttribute('service'), xmlDocQ.getElementsByTagName("song")[i].getElementsByTagName("quality")[0].innerHTML, xmlDocQ.getElementsByTagName("song")[i].getAttribute('songid'), xmlDocQ.getElementsByTagName("song")[i].getAttribute('id'));
                            }
                        }
                        if (queueLength > 0) {
                            playQueue.innerHTML += '<p>Shown ' + i + ' of ' + xmlDocQ.getElementsByTagName("song").length + ' items</p>';
                            playQueue.innerHTML += '<button onclick="clearQueue()" id="clearqueue">Clear</button>';
                        } else {
                            playQueue.innerHTML += '<p>There are no songs in the play queue</p>';
                        }
                        playQueue.innerHTML += '<button onclick="loadPanel1View(\'controls\')" id="showControls">Back</button>';
                        playQueue.innerHTML += '<div class="queuescrollspace"></div>';

                    }
                }
            };

        }
        function clearQueue() {
            control('/Clear');
            getPlayQueue();
        }
        function removeFromQueue(id) {
            control('/Delete?id=' + id);
            getPlayQueue();
        }
        function listpresets() {
            var xhttpP = new XMLHttpRequest();
            xhttpP.open("GET", url + '/Presets', true);
            xhttpP.send();
            xhttpP.onreadystatechange = function () {
                if (xhttpP.readyState == 4) {
                    if (xhttpP.status == 200) {
                        var xmlDocP = xhttpP.responseXML;
                        document.getElementById("presets").innerHTML = '';
                        if (typeof xmlDocP.getElementsByTagName("preset")[0] != "undefined") {
                            for (i = 0; i < xmlDocP.getElementsByTagName("preset").length; i++) {
                                if (typeof xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') != 'undefined' && xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') != null) {
                                    document.getElementById("presets").innerHTML += '<button onclick=\"control(\'/Preset?id=' + xmlDocP.getElementsByTagName("preset")[i].getAttribute('id') + '\'\)"" id=\"' + xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') + '\">' + xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') + '</button>';
                                }
                            }
                        }
                    }
                }
            };
        }
        // TODO in content browsing: 
        // display categories (iterate through xml instead of extracting tags?)
        // finetune styling
        function browseContent(key, query) {
            var xhttpB = new XMLHttpRequest();
            var browseLink = '';
            if (!key) {
                browseLink = '/Browse';
            } else if (key.startsWith('/')) {
                browseLink = key;
            } else {
                browseLink = '/Browse?key=' + key;
            }
            if (query) {
                browseLink += '&q=' + query;
                searchQuery = ' value="' + query + '" ';
                previousBrowse = "browseContent('" + key + "','" + query + "')";
            } else {
                searchQuery = ' value="" ';
                previousBrowse = "browseContent('" + browseLink + "')";
            }
            var browseBackLink = '';
            if (browseBreadCrumbs.includes(previousBrowse)) {
                browseBackLink = browseBreadCrumbs[browseBreadCrumbs.indexOf(previousBrowse) - 1];
            } else {
                browseBackLink = browseBreadCrumbs[browseBreadCrumbs.length - 1];
            }
            var browseHtml = '<button onclick="' + browseBackLink + '">Back</button>';
            browseBreadCrumbs.push(previousBrowse);
            xhttpB.open("GET", url + browseLink, true);
            xhttpB.send();
            xhttpB.onreadystatechange = function () {
                if (xhttpB.readyState == 4) {
                    if (xhttpB.status == 200) {
                        var xmlDocB = xhttpB.responseXML;
                        if (typeof xmlDocB.getElementsByTagName("*")[0].getAttribute('service') != "undefined" && xmlDocB.getElementsByTagName("*")[0].getAttribute('service') != null) {
                            var browseService = xmlDocB.getElementsByTagName("*")[0].getAttribute('service');
                            browseHtml += '<h1>' + browseService + '</h1>';
                        } else {
                            var browseService = '';
                        }
                        if (typeof xmlDocB.getElementsByTagName("*")[0].getAttribute('searchKey') != "undefined" && xmlDocB.getElementsByTagName("*")[0].getAttribute('searchKey') != null) {
                            browseHtml += '<form action="javascript:void(0);" ><input' + searchQuery + 'type="text" id="searchquery" name="searchquery"><input id="searchbutton" type="submit" value="Search" onclick="search(\'' + xmlDocB.getElementsByTagName("*")[0].getAttribute('searchKey') + '\')"><input type="hidden" id="searchkey" name="searchkey" value="' + xmlDocB.getElementsByTagName("*")[0].getAttribute('searchKey') + '"></form>';
                        }
                        if (typeof xmlDocB.getElementsByTagName("category")[0] != "undefined") {
                            //iterate through categories or iterate through alle main level tags one level higher? 
                        }
                        if ((typeof xmlDocB.getElementsByTagName("browse")[0] != "undefined" || typeof xmlDocB.getElementsByTagName("radiotime")[0] != "undefined") && typeof xmlDocB.getElementsByTagName("item")[0] != "undefined") {
                            for (i = 0; i < xmlDocB.getElementsByTagName("item").length; i++) {
                                var level1 = level1 = xmlDocB.getElementsByTagName("item")[i].getAttribute('text');
                                var level2 = '';
                                var level3 = '';
                                var level4 = '';
                                var imageUrl = '';
                                var iconUrl = '';
                                var action0 = '';
                                var action1 = '';
                                var id = '';
                                var action2 = '';
                                var action3 = '';
                                if (xmlDocB.getElementsByTagName("item")[i].getAttribute('browseKey')) {
                                    action0 = 'browseContent(\'' + xmlDocB.getElementsByTagName("item")[i].getAttribute('browseKey') + '\')';
                                } else if (xmlDocB.getElementsByTagName("item")[i].getAttribute('playURL')) {
                                    action0 = 'browseContent(\'' + xmlDocB.getElementsByTagName("item")[i].getAttribute('playURL') + '\')';
                                } else if (xmlDocB.getElementsByTagName("item")[i].getAttribute('URL')) {
                                    if (xmlDocB.getElementsByTagName("item")[i].getAttribute('type') == 'audio') {
                                        action0 = 'control(\'/Play?url=' + xmlDocB.getElementsByTagName("item")[i].getAttribute('URL') + '\')';
                                    } else if (xmlDocB.getElementsByTagName("item")[i].getAttribute('type') == 'link') {
                                        action0 = 'browseContent(\'/RadioBrowse?service=' + browseService + '&url=' + xmlDocB.getElementsByTagName("item")[i].getAttribute('URL') + '\')';
                                    } else {
                                        //what is the default for item URLs?
                                    }
                                }
                                if (typeof xmlDocB.getElementsByTagName("item")[i].getAttribute('image') != 'undefined') {
                                    imageUrl = xmlDocB.getElementsByTagName("item")[i].getAttribute('image');
                                }
                                browseHtml += buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3);
                            }
                        }
                        if (typeof xmlDocB.getElementsByTagName("albums")[0] != "undefined" && typeof xmlDocB.getElementsByTagName("album")[0] != "undefined") {
                            if (xmlDocB.getElementsByTagName("albums")[0].getAttribute('artistid') || key.includes('artistid')) {
                                browseHtml += '<h2>Albums of artist</h2>';
                            } else {
                                browseHtml += '<h2>Albums</h2>';
                            }
                            for (i = 0; i < xmlDocB.getElementsByTagName("album").length; i++) {
                                var browseHtml2 = '';
                                var level1 = '';
                                var level2 = '';
                                var level3 = '';
                                var level4 = '';
                                var imageUrl = '';
                                var iconUrl = '';
                                var action0 = '';
                                var action1 = '';
                                var id = '';
                                var action2 = '';
                                var action3 = '';
                                browseHtml += '<a href="#" ';
                                if (xmlDocB.getElementsByTagName("album")[i].getAttribute('albumid') && browseService) {
                                    action0 = "control('/Add?albumid=" + xmlDocB.getElementsByTagName("album")[i].getAttribute('albumid') + "&service=" + browseService + "&playnow=1')";
                                    action1 = "browseContent('/Songs?albumid=" + xmlDocB.getElementsByTagName("album")[i].getAttribute('albumid') + "&service=" + browseService + "')";
                                    imageUrl = '/Artwork?service=' + browseService + '&albumid=' + xmlDocB.getElementsByTagName("album")[i].getAttribute('albumid');
                                    id = xmlDocB.getElementsByTagName("album")[i].getAttribute('albumid');
                                }
                                if (xmlDocB.getElementsByTagName("album")[i].getAttribute('artistid') && browseService) {
                                    action2 = "browseContent('/Albums?artistid=" + xmlDocB.getElementsByTagName("album")[i].getAttribute('artistid') + "&service=" + browseService + "')";
                                }
                                if (typeof xmlDocB.getElementsByTagName("album")[i].getElementsByTagName('title')[0] != "undefined") {
                                    level1 = xmlDocB.getElementsByTagName("album")[i].getElementsByTagName('title')[0].innerHTML;
                                }
                                if (typeof xmlDocB.getElementsByTagName("album")[i].getElementsByTagName('art')[0] != "undefined") {
                                    level2 = xmlDocB.getElementsByTagName("album")[i].getElementsByTagName('art')[0].innerHTML
                                }
                                //if (typeof xmlDocB.getElementsByTagName("album")[i].getAttribute('image') != null) {
                                //    imageUrl = xmlDocB.getElementsByTagName("album")[i].getAttribute('image');
                                //}
                                if (typeof xmlDocB.getElementsByTagName("album")[i].getAttribute('quality') != 'undefined') {
                                    level4 = xmlDocB.getElementsByTagName("album")[i].getAttribute('quality').toUpperCase();
                                }
                                browseHtml += buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3);
                            }
                        }
                        if (typeof xmlDocB.getElementsByTagName("songs")[0] != "undefined" && typeof xmlDocB.getElementsByTagName("song")[0] != "undefined") {
                            if (xmlDocB.getElementsByTagName("songs")[0].getAttribute('albumid')) {
                                browseHtml += '<h2>Songs on album</h2>';
                            } else if (xmlDocB.getElementsByTagName("songs")[0].getAttribute('artistid')) {
                                browseHtml += '<h2>Songs of artist</h2>';
                            } else {
                                browseHtml += '<h2>Songs</h2>';
                            }
                            for (i = 0; i < xmlDocB.getElementsByTagName("song").length; i++) {
                                var browseHtml2 = '';
                                var level1 = '';
                                var level2 = '';
                                var level3 = '';
                                var level4 = '';
                                var imageUrl = '';
                                var iconUrl = '';
                                var action0 = '';
                                var action1 = '';
                                var id = '';
                                var action2 = '';
                                var action3 = '';
                                if (xmlDocB.getElementsByTagName("song")[i].getAttribute('songid')) {
                                    id = xmlDocB.getElementsByTagName("song")[i].getAttribute('songid');
                                    action0 = "control('/Add?id=" + xmlDocB.getElementsByTagName("song")[i].getAttribute('songid') + "&playnow=1')";
                                    imageUrl = '/Artwork?service=' + browseService + '&songid=' + xmlDocB.getElementsByTagName("song")[i].getAttribute('songid');
                                }
                                if (xmlDocB.getElementsByTagName("song")[i].getAttribute('artistid') && browseService) {
                                    action2 = "browseContent('/Albums?artistid=" + xmlDocB.getElementsByTagName("song")[i].getAttribute('artistid') + "&service=" + browseService + "')";
                                    action1 = action0;
                                }
                                if (xmlDocB.getElementsByTagName("song")[i].getAttribute('albumid') && browseService) {
                                    action3 = "browseContent('/Songs?albumid=" + xmlDocB.getElementsByTagName("song")[i].getAttribute('albumid') + "&service=" + browseService + "')";
                                }
                                if (typeof xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("title")[0] != 'undefined') {
                                    level1 = xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("title")[0].innerHTML;
                                }
                                if (typeof xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("art")[0] != 'undefined') {
                                    level2 = xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("art")[0].innerHTML;
                                }
                                if (typeof xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("alb")[0] != 'undefined') {
                                    level3 = xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("alb")[0].innerHTML;
                                }
                                if (typeof xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("quality")[0] != 'undefined') {
                                    level4 = xmlDocB.getElementsByTagName("song")[i].getElementsByTagName("quality")[0].innerHTML.toUpperCase();
                                }
                                browseHtml += buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3);
                            }
                        }
                        if (typeof xmlDocB.getElementsByTagName("playlists")[0] != "undefined" && typeof xmlDocB.getElementsByTagName("name")[0] != "undefined") {
                            browseHtml += '<h2>Playlists</h2>';
                            for (i = 0; i < xmlDocB.getElementsByTagName("name").length; i++) {
                                var browseHtml2 = '';
                                var level1 = xmlDocB.getElementsByTagName("name")[i].innerHTML || '';
                                var level2 = '';
                                var level3 = '';
                                var level4 = '';
                                var imageUrl = '';
                                var iconUrl = '';
                                var action0 = '';
                                var action1 = '';
                                var id = '';
                                var action2 = '';
                                var action3 = '';
                                var playListLink = '';
                                if (xmlDocB.getElementsByTagName("name")[i].getAttribute('preset_url')) {
                                    action0 = "control('" + xmlDocB.getElementsByTagName("name")[i].getAttribute('preset_url') + "')";
                                }
                                if (xmlDocB.getElementsByTagName("name")[i].getAttribute('id') && browseService) {
                                    action0 = "control('" + '/Load?id=' + xmlDocB.getElementsByTagName("name")[i].getAttribute('id') + '&service=' + browseService + "')";
                                    action1 = "browseContent('" + '/Songs?playlistid=' + xmlDocB.getElementsByTagName("name")[i].getAttribute('id') + '&service=' + browseService + "')";
                                }
                                if (xmlDocB.getElementsByTagName("name")[i].getAttribute('tracks')) {
                                    level4 = xmlDocB.getElementsByTagName("name")[i].getAttribute('tracks') + ' tracks';
                                }
                                if (xmlDocB.getElementsByTagName("name")[i].getAttribute('description')) {
                                    level2 = xmlDocB.getElementsByTagName("name")[i].getAttribute('description');
                                }
                                imageUrl = 'play';
                                browseHtml += buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3);
                            }
                        }
                        if (typeof xmlDocB.getElementsByTagName("artists")[0] != "undefined" && typeof xmlDocB.getElementsByTagName("art")[0] != "undefined") {
                            browseHtml += '<h2>Artists</h2>';
                            for (i = 0; i < xmlDocB.getElementsByTagName("art").length; i++) {
                                var browseHtml2 = '';
                                var level1 = '';
                                var level2 = '';
                                var level3 = '';
                                var level4 = '';
                                var imageUrl = '';
                                var iconUrl = '';
                                var action0 = '';
                                var action1 = '';
                                var id = xmlDocB.getElementsByTagName("art")[i].getAttribute("artistid") || '';
                                var action2 = '';
                                var action3 = '';
                                if (typeof xmlDocB.getElementsByTagName("art")[i].innerHTML != 'undefined') {
                                    level1 = xmlDocB.getElementsByTagName("art")[i].innerHTML;
                                }
                                if (id) {
                                    action0 = 'browseContent(\'/Albums?artistid=' + xmlDocB.getElementsByTagName("art")[i].getAttribute("artistid") + '&service=' + browseService + '\')';
                                }
                                if (typeof xmlDocB.getElementsByTagName("art")[i].getAttribute('image') != 'undefined') {
                                    imageUrl = xmlDocB.getElementsByTagName("art")[i].getAttribute('image');
                                }
                                browseHtml += buildListItem(level1, level2, level3, level4, imageUrl, iconUrl, action0, action1, id, action2, action3);
                                //browseHtml += '<a href="#" onclick="browseContent(\'/Albums?artistid=' + xmlDocB.getElementsByTagName("art")[i].getAttribute("artistid") + '&service=' + browseService + '\')">' + xmlDocB.getElementsByTagName("art")[i].innerHTML + '</a>';
                            }
                        }
                        browse.innerHTML = browseHtml;
                    }
                }
            };
        }
        function search(searchKey) {
            if (document.getElementById("searchquery").value) {
                browseContent(searchKey, document.getElementById("searchquery").value);
            } else {
                //console.log('searchkey:' + searchKey + ' searchquery:' + document.getElementById("searchquery").value);
            }
        }
    </script>
</body>

</html>