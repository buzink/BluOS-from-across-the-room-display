<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
    </head>
    <style>
        body {
            background-color: black;
            color: white;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-items: center;
            height: 98vh;
        }
        #leftright {
            display: flex;
            height: 90vh;
            width: 100%;
        }
        #left {
            width: 60%;
            padding-left: 3vh;
            padding-right: 3vh;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-items: center;
        }
        #right {
            width: 40%;
            padding-right: 3vh;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-items: center; 
        }
        #albumcover {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 90vh;
        }
        #controls {
            display: none;
            flex-wrap: wrap;
            flex-direction: row;
            margin-left: auto;
            margin-right: auto;
            width: 90vh;
            font-size: 3vh;
        }
        #controls button {
            font-size: 3vh;
            margin: 0 1vh 1vh 0; 
            height: 4vh;
            display: inline-block;
        }
        #hideControls {
            height: 4vh;
        }
        #receiverON {
            display: none;
        }
        #receiverOFF {
            display: none;
        }
        #receiverInputBluOS {
            display: none;
        }
        #songTitle {
            font-size: 12vh;
            width: 100%;
        }
        #artistName {
            font-size: 8vh;
            width: 100%;
            margin-top: 3vh;
        }
        #albumTitle {
            font-size: 5vh;
            margin-top: 3vh;
            width: 100%;
        }
        #meta {
            display: flex;
            margin-top: 3vh;
            font-size: 3vh;
            width: 100%;
        }
        #serviceIcon {
            height: 30px;
        }
        #station {
            margin-left: 1vh;
        }
        #quality {
            margin-left: 1vh;
        }
        </style>
    <body>

            <div id="leftright">
                <div id="left">
                    <div onclick="toggleControls();" id="leftflex">
                        <div id="songTitle"></div>
                        <div id="artistName"></div>
                        <div id="albumTitle"></div>
                        <div id="meta">
                            <img id="serviceIcon" src=""/>
                            <div id="station">
                            </div>
                            <div id="quality">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="right">
                    <img onclick="toggleControls();" id="albumcover" src=""/>
                    <div id="controls">
                        <button onclick="control('/Pause?toggle=1')" id="togglePause">Play</button>
                        <button onclick="control('/Back')" id="back">Back</button>
                        <button onclick="control('/Skip')" id="skip">Skip</button>
                        <button onclick="control(VolumeUpUrl)" id="volumeUp">Vol +</button>
                        <button onclick="control(VolumeDownUrl)" id="volumeDown">Vol -</button>
                        <div id="actions">
                        </div>
                        <div id="presets">
                        </div>
                        <button onclick="control(receiverOnUrl)" id="receiverON">ON</button>
                        <button onclick="control(receiverOffUrl)" id="receiverOFF">OFF</button>
                        <button onclick="control(receiverInputBluOSUrl)" id="receiverInputBluOS">BluOS</button>
                        <button onclick="location.reload()">Reload app</button>
                        <img onclick="toggleControls();" id="hideControls" src="">
                    </div>
                </div>
            </div>

        <script>
        //Change ipAddress and port to that of your BluOS player:    
        var ipAddress = "192.168.2.86";
        var port = "11000";
        var receiverOnUrl = 'http://192.168.2.79:8000/api/PWON';
        var receiverOffUrl = 'http://192.168.2.79:8000/api/PWSTANDBY';
        var receiverInputBluOSUrl = 'http://192.168.2.79:8000/api/MSQUICK1';
        var receiverVolumeUpUrl = 'http://192.168.2.79:8000/api/MVUP';
        var receiverVolumeDownUrl = 'http://192.168.2.79:8000/api/MVDOWN';
        //stop editing here unless you know what your are doing :)
        var url = 'http://' + ipAddress + ':' + port;
        if (receiverVolumeUpUrl != '' && receiverVolumeUpUrl != '') {
            var VolumeUpUrl = receiverVolumeUpUrl;
            var VolumeDownUrl = receiverVolumeDownUrl;
        } else {
            var VolumeUpUrl = '/Volume?db=1&tell_slaves=off';
            var VolumeDownUrl = '/Volume?db=-1&tell_slaves=off';
        }
        function longPoll() {    
            var xhttp = new XMLHttpRequest();
            console.log("Api call " + call);
            xhttp.open("GET", url + "/Status?timeout=100&etag=" + eTag, true);
            xhttp.send();
            const tryAgain = setTimeout(() => {
                console.log("Initiate timeout api call " + call + " (update " + update +")");
                xhttp.abort;
                longPoll(); 
            }, 101000);
            xhttp.onreadystatechange = function() {
                console.log("Readystate " + xhttp.readyState + " / Status " + xhttp.status);
                if (xhttp.readyState == 4) {
                    if(xhttp.status == 200) {
                        listpresets();
                        console.log("Cancel timeout api call " + (call-1) + " (update " + update + ")");
                        clearTimeout(tryAgain);
                        var xmlDoc = xhttp.responseXML;
                        eTag = xmlDoc.getElementsByTagName('status')[0].getAttribute('etag');
                        var quality;
                        let song = {
                            "time": new Date(),
                            "service": xmlDoc.getElementsByTagName("serviceName")[0].innerHTML
                        };
                        if (xmlDoc.getElementsByTagName("serviceName")[0].innerHTML == "Radio Paradise") {
                            if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") { 
                                document.getElementById("songTitle").innerHTML = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                                song.title = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                            } else {
                                document.getElementById("songTitle").innerHTML = "";
                                song.title = '';
                            }
                            if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") { 
                                document.getElementById("artistName").innerHTML = xmlDoc.getElementsByTagName("title3")[0].innerHTML.split(" • ")[0];
                                song.artist = xmlDoc.getElementsByTagName("title3")[0].innerHTML.split(" • ")[0];
                            } else {
                                document.getElementById("artistName").innerHTML = "";
                                song.artist = '';
                            }
                            if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") { 
                                document.getElementById("albumTitle").innerHTML = xmlDoc.getElementsByTagName("title3")[0].innerHTML.split(" • ")[1];
                                song.album = xmlDoc.getElementsByTagName("title3")[0].innerHTML.split(" • ")[1];
                            } else {
                                document.getElementById("albumTitle").innerHTML = "";
                                song.album = '';
                            }
                            if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") { 
                                document.getElementById("station").innerHTML = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                                song.station = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                            } else {
                                document.getElementById("station").innerHTML = "";
                            }
                        } else if (xmlDoc.getElementsByTagName("serviceName")[0].innerHTML == "Calm Radio") {
                            if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {
                                document.getElementById("songTitle").innerHTML = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                            } else {
                                document.getElementById("songTitle").innerHTML = "";
                            }
                            if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {
                                document.getElementById("station").innerHTML = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                            } else {
                                document.getElementById("station").innerHTML = "";
                            }
                            document.getElementById("albumTitle").innerHTML = "";
                            document.getElementById("artistName").innerHTML = "";
                        } else if (xmlDoc.getElementsByTagName("serviceName")[0].innerHTML == "TuneIn") {
                            if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") {       
                                document.getElementById("songTitle").innerHTML = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                            } else {
                                document.getElementById("songTitle").innerHTML = "";
                            }
                            if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") { 
                                document.getElementById("artistName").innerHTML = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                            } else {
                                document.getElementById("artistName").innerHTML = "";
                            }    
                            if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {
                                document.getElementById("albumTitle").innerHTML = xmlDoc.getElementsByTagName("title3")[0].innerHTML;
                            } else {
                                document.getElementById("albumTitle").innerHTML = "";
                            }
                            document.getElementById("station").innerHTML = xmlDoc.getElementsByTagName("serviceName")[0].innerHTML;
                        } else {
                            if (typeof xmlDoc.getElementsByTagName("title1")[0] != "undefined") {       
                                document.getElementById("songTitle").innerHTML = xmlDoc.getElementsByTagName("title1")[0].innerHTML;
                            } else {
                             document.getElementById("songTitle").innerHTML = "";
                            }
                            if (typeof xmlDoc.getElementsByTagName("title2")[0] != "undefined") { 
                                document.getElementById("artistName").innerHTML = xmlDoc.getElementsByTagName("title2")[0].innerHTML;
                            } else {
                                document.getElementById("artistName").innerHTML = "";
                            }    
                            if (typeof xmlDoc.getElementsByTagName("title3")[0] != "undefined") {
                                document.getElementById("albumTitle").innerHTML = xmlDoc.getElementsByTagName("title3")[0].innerHTML;
                            } else {
                             document.getElementById("albumTitle").innerHTML = "";
                            }
                            document.getElementById("station").innerHTML = "";
                        }
                        if (typeof xmlDoc.getElementsByTagName("image")[0] != "undefined") {
                            if (xmlDoc.getElementsByTagName("image")[0].innerHTML.startsWith("http")  ) {
                             document.getElementById("albumcover").src = xmlDoc.getElementsByTagName("image")[0].innerHTML;
                             song.albumCover = xmlDoc.getElementsByTagName("image")[0].innerHTML;
                            } else {
                            document.getElementById("albumcover").src = "http://" + ipAddress + ":" + port + xmlDoc.getElementsByTagName("image")[0].innerHTML;
                            song.albumCover = "http://" + ipAddress + ":" + port + xmlDoc.getElementsByTagName("image")[0].innerHTML;
                            }
                        } else {
                            document.getElementById("albumcover").src = "";
                            song.albumCover = '';
                        }
                        document.getElementById("hideControls").src = song.albumCover;
                        if (typeof xmlDoc.getElementsByTagName("serviceIcon")[0] != "undefined") {   
                            document.getElementById("serviceIcon").src = "http://" + ipAddress + ":" + port + xmlDoc.getElementsByTagName("serviceIcon")[0].innerHTML;
                            song.serviceIcon = "http://" + ipAddress + ":" + port + xmlDoc.getElementsByTagName("serviceIcon")[0].innerHTML;
                        } else {
                            document.getElementById("serviceIcon").src = "";
                            song.serviceIcon = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("quality")[0] != "undefined") {
                            if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "mqa") {
                                document.getElementById("quality").innerHTML = "MQA <span style=\"color:#4dbb63;\">•</span>";
                                song.quality = "MQA <span style=\"color:#4dbb63;\">•</span>";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "mqaAuthored") {
                                document.getElementById("quality").innerHTML = "MQA <span style=\"color:#3ec4e4;\">•</span>";
                                song.quality = "MQA <span style=\"color:#3ec4e4;\">•</span>";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "hd") {
                                document.getElementById("quality").innerHTML = "Hi&middot;Res";
                                song.quality = "Hi&middot;Res";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "cd") {
                                document.getElementById("quality").innerHTML = "CD";
                                song.quality = "CD";
                            } else if (xmlDoc.getElementsByTagName("quality")[0].innerHTML == "dolbyAudio") {
                                document.getElementById("quality").innerHTML = "DolbyDigital";
                                song.quality = "DolbyDigital";
                            } else {
                                document.getElementById("quality").innerHTML = xmlDoc.getElementsByTagName("quality")[0].innerHTML;
                                song.quality = xmlDoc.getElementsByTagName("quality")[0].innerHTML;
                            }
                        } else if (typeof xmlDoc.getElementsByTagName("streamUrl")[0] != "undefined") {     
                            document.getElementById("quality").innerHTML = xmlDoc.getElementsByTagName("streamUrl")[0].innerHTML;
                            song.quality = xmlDoc.getElementsByTagName("streamUrl")[0].innerHTML;            
                        } else {
                            document.getElementById("quality").innerHTML = "";
                            song.quality = '';
                        }
                        if (typeof xmlDoc.getElementsByTagName("streamFormat")[0] != "undefined" && xmlDoc.getElementsByTagName("quality")[0].innerHTML != "mqa" && xmlDoc.getElementsByTagName("quality")[0].innerHTML != "mqaAuthored") {
                            song.quality = xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML;
                            if (typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[0] != "undefined" &&  typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[0] != "undefined" &&  typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[1] != "undefined" &&  typeof xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[2] != "undefined") {
                                document.getElementById("quality").innerHTML = document.getElementById("quality").innerHTML + ' ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[0] + ' ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[1] + '-bit/'  + (xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[0]/1000) + 'kHz ' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML.split(' ')[1].split('/')[2] + 'ch';                
                            } else {
                                document.getElementById("quality").innerHTML = document.getElementById("quality").innerHTML + ' (' + xmlDoc.getElementsByTagName("streamFormat")[0].innerHTML + ')';
                            }
                        }
                        if (typeof playHistory[0] != 'undefined') {
                            if (playHistory[0].title != song.title || playHistory[0].artist != song.artist || playHistory[0].album != song.album || playHistory[0].service != song.service || playHistory[0].quality != song.quality) {
                                playHistory.unshift(song);
                            }
                        } else {
                            playHistory.unshift(song);
                        }
                        console.log(playHistory);
                        if (typeof xmlDoc.getElementsByTagName("state")[0] != "undefined") {
                            if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'pause') {
                                document.getElementById("togglePause").innerHTML = "Play";
                                document.getElementById("togglePause").style.display = 'inline-block';
                                document.getElementById("back").style.display = 'inline-block';
                                document.getElementById("skip").style.display = 'inline-block';
                            } else if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'play') {
                                document.getElementById("togglePause").innerHTML = "Pause";
                                document.getElementById("togglePause").style.display = 'inline-block';
                                document.getElementById("back").style.display = 'inline-block';
                                document.getElementById("skip").style.display = 'inline-block';
                            } else if (xmlDoc.getElementsByTagName("state")[0].innerHTML == 'stream') {
                                document.getElementById("togglePause").innerHTML = "Pause";
                                document.getElementById("togglePause").style.display = 'inline-block';
                                document.getElementById("back").style.display = 'none';
                                document.getElementById("skip").style.display = 'none';
                            } else {
                                document.getElementById("togglePause").style.display = 'none';
                                document.getElementById("back").style.display = 'none';
                                document.getElementById("skip").style.display = 'none';
                            }
                        }
                        document.getElementById("actions").innerHTML = '';
                        if (typeof xmlDoc.getElementsByTagName("action")[0] != "undefined") {
                            for (i=0; i < xmlDoc.getElementsByTagName("action").length; i++) {
                                if (typeof xmlDoc.getElementsByTagName("action")[i].getAttribute('url') != 'undefined' && xmlDoc.getElementsByTagName("action")[i].getAttribute('url') != null) {
                                    document.getElementById("actions").innerHTML += '<button onclick=\"control(\'' + xmlDoc.getElementsByTagName("action")[i].getAttribute('url') + '\')\"" id=\"' + xmlDoc.getElementsByTagName("action")[i].getAttribute('name') + '\">' + xmlDoc.getElementsByTagName("action")[i].getAttribute('name') + '</button>';
                                }
                            }
                        }
                        if (receiverOnUrl != '') {
                            document.getElementById("receiverON").style.display = 'inline-block';
                        }
                        if (receiverOffUrl != '') {
                            document.getElementById("receiverOFF").style.display = 'inline-block';
                        }
                        if (receiverInputBluOSUrl != '') {
                            document.getElementById("receiverInputBluOS").style.display = 'inline-block';
                        }
                        console.log("Update " + update);
                        update = update + 1;
                    }
                    if (xhttp.status > 0) {
                        longPoll();
                    }
                }     
            };
            call = call + 1;
        }
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('ipaddress') != null) {
            ipAddress = urlParams.get('ipaddress');
        }
        var update = 1;
        var call = 1;
        var eTag = "";
        let playHistory = [];
        longPoll();
        //controls
        const albumCover = document.getElementById('albumcover');
        const controls = document.getElementById('controls');
        function toggleControls () {
            if (controls.style.display === 'none') {
                controls.style.display = 'flex';
                albumCover.style.display = 'none';    
            } else {
                controls.style.display = 'none';
                albumCover.style.display = 'block'; 
            }
        }
        function control(message) {    
            var xhttpa = new XMLHttpRequest();
            if (message.startsWith('http')) {
                xhttpa.open("GET", message, true);
            } else {
                xhttpa.open("GET", url + message, true);
            }  
            xhttpa.send();
            xhttpa.onreadystatechange = function() {
                if (xhttpa.readyState == 4) {
                    if(xhttpa.status == 200) {
                        var xmlDoca = xhttpa.responseXML;
                    }
                }     
            };
        }
        function listpresets() {    
            var xhttpP = new XMLHttpRequest();
            xhttpP.open("GET", url + '/Presets', true);
            xhttpP.send();
            xhttpP.onreadystatechange = function() {
                if (xhttpP.readyState == 4) {
                    if(xhttpP.status == 200) {
                        var xmlDocP = xhttpP.responseXML;
                        document.getElementById("presets").innerHTML = '';
                        if (typeof xmlDocP.getElementsByTagName("preset")[0] != "undefined") {
                            for (i=0; i < xmlDocP.getElementsByTagName("preset").length; i++) {
                                if (typeof xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') != 'undefined' && xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') != null) {
                                    document.getElementById("presets").innerHTML += '<button onclick=\"control(\'/Preset?id=' + xmlDocP.getElementsByTagName("preset")[i].getAttribute('id') + '\'\)"" id=\"' + xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') + '\">' + xmlDocP.getElementsByTagName("preset")[i].getAttribute('name') + '</button>';
                                }
                            }
                        }
                    }
                }     
            };
        }
        </script> 
</body>
</html>